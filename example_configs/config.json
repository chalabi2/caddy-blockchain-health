{
  "_comment": "Blockchain Health Dynamic Upstream - Chain-Specific Configuration",
  "_description": "This example demonstrates explicit node_type and chain_type configuration for proper chain isolation",
  "_note": "node_type determines health checker (cosmos/evm), chain_type determines grouping (ethereum/base/akash/etc)",
  "admin": {
    "listen": "localhost:2019"
  },
  "apps": {
    "http": {
      "servers": {
        "srv0": {
          "listen": [":443"],
          "routes": [
            {
              "match": [
                {
                  "host": ["cosmos.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "match": [
                        {
                          "path": ["/rpc/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "rpc_servers": "http://cosmos-1:26657 http://cosmos-2:26657 http://cosmos-3:26657"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 2
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/api/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "api_servers": "http://api-1:1317 http://api-2:1317"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ],
              "terminal": true
            },
            {
              "match": [
                {
                  "host": ["ethereum.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "match": [
                        {
                          "path": ["/rpc/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "evm_servers": "http://eth-1:8545 http://eth-2:8545"
                            },
                            "chain": {
                              "node_type": "evm",
                              "chain_type": "ethereum"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/ws/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "evm_ws_servers": "ws://eth-1:8546 ws://eth-2:8546"
                            },
                            "chain": {
                              "node_type": "evm",
                              "chain_type": "ethereum"
                            },
                            "health_check": {
                              "interval": "5s",
                              "timeout": "3s"
                            },
                            "block_validation": {
                              "height_threshold": 10,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ],
              "terminal": true
            },
            {
              "match": [
                {
                  "host": ["althea.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "match": [
                        {
                          "path": ["/rpc/cosmos/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "rpc_servers": "http://althea-rpc-1:26657 http://althea-rpc-2:26657"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/rpc/evm/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "evm_servers": "http://althea-evm-1:8545 http://althea-evm-2:8545"
                            },
                            "chain": {
                              "node_type": "evm",
                              "chain_type": "ethereum"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/api/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "api_servers": "http://althea-api-1:1317 http://althea-api-2:1317"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "10s",
                              "timeout": "10s"
                            },
                            "block_validation": {
                              "height_threshold": 3,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 1
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ],
              "terminal": true
            },
            {
              "match": [
                {
                  "host": ["dev-blockchain.localhost"]
                }
              ],
              "handle": [
                {
                  "handler": "reverse_proxy",
                  "dynamic_upstreams": {
                    "source": "blockchain_health",
                    "environment": {
                      "rpc_servers": "http://localhost:26657",
                      "api_servers": "http://localhost:1317"
                    },
                    "chain": {
                      "chain_type": "cosmos-hub"
                    },
                    "health_check": {
                      "interval": "5s",
                      "timeout": "10s"
                    },
                    "block_validation": {
                      "height_threshold": 20,
                      "external_reference_threshold": 0
                    },
                    "failure_handling": {
                      "min_healthy_nodes": 0
                    },
                    "monitoring": {
                      "log_level": "debug",
                      "metrics_enabled": true
                    }
                  }
                }
              ],
              "terminal": true
            },
            {
              "match": [
                {
                  "host": ["prod-api.example.com"]
                }
              ],
              "handle": [
                {
                  "handler": "subroute",
                  "routes": [
                    {
                      "match": [
                        {
                          "path": ["/rpc/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "rpc_servers": "http://prod-rpc-1:26657 http://prod-rpc-2:26657 http://prod-rpc-3:26657"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "5s",
                              "timeout": "2s"
                            },
                            "block_validation": {
                              "height_threshold": 2,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 3,
                              "circuit_breaker_threshold": 0.7,
                              "grace_period": "30s"
                            },
                            "performance": {
                              "cache_duration": "15s",
                              "max_concurrent_checks": 20
                            },
                            "monitoring": {
                              "metrics_enabled": true,
                              "log_level": "info"
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/api/*"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "reverse_proxy",
                          "dynamic_upstreams": {
                            "source": "blockchain_health",
                            "environment": {
                              "api_servers": "http://prod-api-1:1317 http://prod-api-2:1317 http://prod-api-3:1317"
                            },
                            "chain": {
                              "node_type": "cosmos",
                              "chain_type": "cosmos-hub"
                            },
                            "health_check": {
                              "interval": "5s",
                              "timeout": "2s"
                            },
                            "block_validation": {
                              "height_threshold": 2,
                              "external_reference_threshold": 0
                            },
                            "failure_handling": {
                              "min_healthy_nodes": 3
                            },
                            "monitoring": {
                              "metrics_enabled": true
                            }
                          }
                        }
                      ]
                    },
                    {
                      "match": [
                        {
                          "path": ["/blockchain-health"]
                        }
                      ],
                      "handle": [
                        {
                          "handler": "static_response",
                          "status_code": 200,
                          "body": "OK"
                        }
                      ]
                    }
                  ]
                }
              ],
              "terminal": true
            }
          ]
        }
      }
    }
  }
}
